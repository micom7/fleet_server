# Симулятори модулів ICP DAS

Симулятори для тестування системи збору даних без реального обладнання.

## Модулі

### ET-7017 Simulator
Симулює **8-канальний аналоговий вхід** (4-20 мА):
- Modbus TCP сервер на порту 5020 (перший модуль) або 5021 (другий модуль)
- Input Registers 0-7: значення AI каналів (16-bit)
- Діапазон значень: 6400 (4 мА) до 32000 (20 мА)
- Автоматично генерує реалістичні значення з невеликими коливаннями

### ET-7284 Simulator
Симулює **лічильник/енкодер/частота** (32-bit):
- Modbus TCP сервер на порту 5022
- Input Registers 16-23: лічильники каналів 0-3 (32-bit кожен = 2 реєстри)
- Input Registers 24-31: частота каналів 4-7 (32-bit кожна = 2 реєстри)
- Симулює рух: лічильник збільшується з часом на основі швидкості та PPM

## Використання

### Через Docker Compose
Симулятори автоматично запускаються разом з іншими сервісами:
```bash
docker compose up -d
```

### Локально (без Docker)
```bash
# Встановити залежності
pip install -r requirements.txt

# Запустити симулятори окремо
python et7017_simulator.py 5020 1    # ET-7017 #1 на порту 5020
python et7017_simulator.py 5021 1    # ET-7017 #2 на порту 5021
python et7284_simulator.py 5022 1 1000  # ET-7284 на порту 5022, PPM=1000
```

## Modbus Реєстри

### ET-7017
- **Input Registers** (function code 04):
  - Реєстр 0: AI канал 0 (16-bit, 6400-32000 для 4-20 мА)
  - Реєстр 1: AI канал 1
  - ... до реєстру 7: AI канал 7

### ET-7284
- **Input Registers** (function code 04):
  - Реєстри 16-17: Лічильник каналу 0 (32-bit: Low, High)
  - Реєстри 18-19: Лічильник каналу 1
  - Реєстри 20-21: Лічильник каналу 2
  - Реєстри 22-23: Лічильник каналу 3
  - Реєстри 24-25: Частота каналу 4 (32-bit: Low, High)
  - Реєстри 26-27: Частота каналу 5
  - Реєстри 28-29: Частота каналу 6
  - Реєстри 30-31: Частота каналу 7

## Тестування

### Скрипти в цій папці

| Файл | Що робить |
|---|---|
| `test_client.py` | Повна перевірка всіх трьох симуляторів: виводить raw + мА для ET-7017, імпульси + Гц для ET-7284 |
| `quick_test.py` | Швидка перевірка тільки ET-7017 #1 (порт 5020): підключення + 8 каналів |
| `test_server_minimal.py` | Мінімальний Modbus TCP сервер з фіксованими значеннями (порт 5020) — для перевірки клієнтів без симулятора |
| `test_simple.py` | Те саме що `test_server_minimal.py`, але значення однакові для всіх каналів |

#### Повна перевірка (всі три симулятори)
```bash
python test_client.py
```

Очікуваний вивід:
- ET-7017: raw 6400–32000, значення в мА
- ET-7284: лічильник каналу 0 зростає (~500 імп/сек при PPM=1000), частота каналу 4 = 500 Гц

#### Швидка перевірка (тільки ET-7017 #1)
```bash
python quick_test.py
```

#### Перевірка клієнта без симулятора
Якщо потрібно перевірити Modbus клієнт проти сервера з передбачуваними значеннями:
```bash
# Запускає сервер на порту 5020 з фіксованими значеннями (10000–17000 по каналах)
python test_server_minimal.py
```

### Зовнішні Modbus клієнти

- [Modbus Poll](https://www.modbustools.com/modbus_poll.html) (Windows, GUI)
- [QModMaster](https://sourceforge.net/projects/qmodmaster/) (крос-платформний, GUI)

Параметри підключення:

| | ET-7017 #1 | ET-7017 #2 | ET-7284 |
|---|---|---|---|
| IP | localhost | localhost | localhost |
| Port | 5020 | 5021 | 5022 |
| Unit ID | 1 | 1 | 1 |
| Function | 04 | 04 | 04 |
| Start address | 0 | 0 | 16 |
| Count | 8 | 8 | 16 |


#Зупинка симуляторів:
  netstat -ano | findstr "5020 5021 5022"
      Знайдеш PID у крайній правій колонці, потім:
  taskkill /PID <номер> /F
      Або одразу вбити всі Python-процеси (якщо немає інших важливих):
  taskkill /IM python.exe /F