# Auto Telemetry ‚Äî –ø—Ä–æ–º–∏—Å–ª–æ–≤–∞ —Å–∏—Å—Ç–µ–º–∞ –∑–±–æ—Ä—É –¥–∞–Ω–∏—Ö (DAQ)

–°–∏—Å—Ç–µ–º–∞ –∑–±–æ—Ä—É –¥–∞–Ω–∏—Ö –Ω–∞ –±–∞–∑—ñ **ICP DAS** (Modbus TCP), **PostgreSQL** —Ç–∞ **Python**.

## –û–±–ª–∞–¥–Ω–∞–Ω–Ω—è

- **–ö–æ–Ω—Ç—Ä–æ–ª–µ—Ä:** ASUS NUC (Ubuntu)
- **–ú–æ–¥—É–ª—ñ:** 2√ó ET-7017 (16 AI 4‚Äì20 –º–ê), 1√ó ET-7284 (–µ–Ω–∫–æ–¥–µ—Ä/–ª—ñ—á–∏–ª—å–Ω–∏–∫)
- **–ó–≤'—è–∑–æ–∫:** Teltonika RUTX11 (4G, VPN, GPS)

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç—É
```
auto_telemetry/
‚îú‚îÄ‚îÄ collector/       # –°–µ—Ä–≤—ñ—Å –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è –º–æ–¥—É–ª—ñ–≤ (Python, Modbus TCP, 1 –ì—Ü)
‚îú‚îÄ‚îÄ portal/          # –û–ø–µ—Ä–∞—Ç–æ—Ä—Å—å–∫–∏–π UI (–ª–æ–∫–∞–ª—å–Ω–∏–π): SSE, CRUD –∫–æ–Ω—Ñ—ñ–≥—ñ–≤, Grafana iframe
‚îú‚îÄ‚îÄ monitor/         # (–∑–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–æ) –°–µ—Ä–≤—ñ—Å –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É –∞–Ω–æ–º–∞–ª—ñ–π, –∞–ª–µ—Ä—Ç–∏
‚îú‚îÄ‚îÄ outbound/        # (–∑–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–æ) REST API –¥–ª—è –∑–æ–≤–Ω—ñ—à–Ω—å–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ (read-only, VPN)
‚îú‚îÄ‚îÄ db/              # –°—Ö–µ–º–∞ –ë–î (01_init.sql ‚Äî –∑–∞—Å—Ç–æ—Å–æ–≤—É—î—Ç—å—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –≤—Ä—É—á–Ω—É)
‚îú‚îÄ‚îÄ grafana/         # –î–∞—à–±–æ—Ä–¥–∏ —Ç–∞ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
‚îú‚îÄ‚îÄ simulators/      # –°–∏–º—É–ª—è—Ç–æ—Ä–∏ –º–æ–¥—É–ª—ñ–≤ ICP DAS (–¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è)
‚îú‚îÄ‚îÄ docs/            # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è: ADR, —Å–ø–µ—Ü–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è, –ø–ª–∞–Ω–∏
‚îú‚îÄ‚îÄ tests/           # (–∑–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–æ) –ê–≤—Ç–æ–º–∞—Ç–∏–∑–æ–≤–∞–Ω—ñ —Ç–µ—Å—Ç–∏
‚îú‚îÄ‚îÄ .env             # –û–±–ª—ñ–∫–æ–≤—ñ –¥–∞–Ω—ñ —Ç–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è (—Ç–µ—Å—Ç–æ–≤—ñ)
‚îú‚îÄ‚îÄ config.txt       # –Ü–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–∞ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è (IP –∞–¥—Ä–µ—Å–∏ –º–æ–¥—É–ª—ñ–≤, –ø–æ—Ä—Ç–∏)
‚îî‚îÄ‚îÄ README.md
```

## –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞
```
[ICP DAS –º–æ–¥—É–ª—ñ] ‚Äî Modbus TCP
        ‚Üì
   [Collector]  ‚îÄ‚îÄ‚îÄ‚îÄ ZeroMQ PUB (data stream)
        ‚Üì                 ‚Üì
  [PostgreSQL]       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚Üë            ‚Üì           ‚Üì
        ‚îÇ      [Monitor]     [Portal]
        ‚îÇ            ‚îÇ           ‚îÇ
        ‚îÇ    ZeroMQ PUB     ZeroMQ SUB √ó 2
        ‚îÇ      (–∞–ª–µ—Ä—Ç–∏)     (data + –∞–ª–µ—Ä—Ç–∏)
        ‚îÇ            ‚îÇ           ‚îÇ
        ‚îÇ            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí SSE stream
        ‚îÇ                        ‚Üì
        ‚îÇ                  [–û–ø–µ—Ä–∞—Ç–æ—Ä UI]
        ‚îÇ                   ‚îú‚îÄ‚îÄ –ú–æ–Ω—ñ—Ç–æ—Ä (–¥–∞–Ω—ñ + —Ç—Ä–∏–≤–æ–≥–∏)
        ‚îÇ                   ‚îú‚îÄ‚îÄ –ì—Ä–∞—Ñ—ñ–∫–∏ (iframe Grafana)
        ‚îÇ                   ‚îî‚îÄ‚îÄ –ö–æ–Ω—Ñ—ñ–≥–∏ (CRUD)
        ‚îÇ
   [Outbound API]
        ‚Üë
[–ó–æ–≤–Ω—ñ—à–Ω—ñ–π —Å–µ—Ä–≤–µ—Ä] ‚îÄ‚îÄ‚îÄ‚îÄ Pull —á–µ—Ä–µ–∑ VPN
```

### –ö–æ–º—É–Ω—ñ–∫–∞—Ü—ñ—ó –º—ñ–∂ —Å–µ—Ä–≤—ñ—Å–∞–º–∏

| –í—ñ–¥ | –î–æ | –ü—Ä–æ—Ç–æ–∫–æ–ª | –û–ø–∏—Å |
|---|---|---|---|
| Collector | PostgreSQL | SQL | –ó–∞–ø–∏—Å –≤–∏–º—ñ—Ä—é–≤–∞–Ω—å –±–∞—Ç—á-—ñ–Ω—Å–µ—Ä—Ç–æ–º |
| Collector | Monitor | ZeroMQ PUB/SUB | –ü–æ—Ç—ñ–∫ –¥–∞–Ω–∏—Ö –¥–ª—è –≤–∏—è–≤–ª–µ–Ω–Ω—è –∞–Ω–æ–º–∞–ª—ñ–π |
| Collector | Portal | ZeroMQ PUB/SUB | –ü–æ—Ç—ñ–∫ –¥–∞–Ω–∏—Ö –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è |
| Monitor | Portal | ZeroMQ PUB/SUB | –ü–æ—Ç—ñ–∫ —Ç—Ä–∏–≤–æ–≥ |
| Monitor | PostgreSQL | SQL | –ß–∏—Ç–∞–Ω–Ω—è –ø—Ä–∞–≤–∏–ª —Ç—Ä–∏–≤–æ–≥ |
| Portal | PostgreSQL | SQL | CRUD –∫–æ–Ω—Ñ—ñ–≥—ñ–≤, —á–∏—Ç–∞–Ω–Ω—è –º–µ—Ç–∞–¥–∞–Ω–∏—Ö |
| Portal | –ë—Ä–∞—É–∑–µ—Ä | SSE | –ü–æ—Ç—ñ–∫ –¥–∞–Ω–∏—Ö + —Ç—Ä–∏–≤–æ–≥ (Server-Sent Events) |
| Portal | –ë—Ä–∞—É–∑–µ—Ä | HTTP | POST/PUT –¥–ª—è CRUD –∫–æ–Ω—Ñ—ñ–≥—ñ–≤ |
| Outbound | PostgreSQL | SQL | –ß–∏—Ç–∞–Ω–Ω—è —ñ—Å—Ç–æ—Ä–∏—á–Ω–∏—Ö –¥–∞–Ω–∏—Ö (read-only) |
| –ó–æ–≤–Ω—ñ—à–Ω—ñ–π —Å–µ—Ä–≤–µ—Ä | Outbound | HTTP REST | –û—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö —á–µ—Ä–µ–∑ VPN |

## –®–≤–∏–¥–∫–∏–π —Å—Ç–∞—Ä—Ç (–ª–æ–∫–∞–ª—å–Ω–∞ —Ä–æ–∑—Ä–æ–±–∫–∞)

### –ü–µ—Ä–µ–¥—É–º–æ–≤–∏
- Python 3.11+
- PostgreSQL –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ
- Grafana –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ "–ì—Ä–∞—Ñ—ñ–∫–∏")

### 1. –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –±–∞–∑–∏ –¥–∞–Ω–∏—Ö
```bash
# –°—Ç–≤–æ—Ä–∏—Ç–∏ –ë–î —Ç–∞ –∑–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ —Å—Ö–µ–º—É
psql -U postgres -c "CREATE DATABASE auto_telemetry;"
psql -U postgres -d auto_telemetry -f db/01_init.sql
```

### 2. –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ
```bash
pip install -r simulators/requirements.txt
pip install -r collector/requirements.txt
pip install -r portal/requirements.txt
# pip install -r monitor/requirements.txt   # –∑–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–æ
# pip install -r outbound/requirements.txt  # –∑–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–æ
```

### 3. –ù–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ `.env`
```bash
# –ü–µ—Ä–µ–∫–æ–Ω–∞—Ç–∏—Å—è —â–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ –∑–±—ñ–≥–∞—é—Ç—å—Å—è –∑ –ª–æ–∫–∞–ª—å–Ω–æ—é –ë–î
DB_HOST=localhost
DB_PORT=5432
DB_NAME=auto_telemetry
DB_USER=postgres
DB_PASSWORD=your_password

# PIN –¥–ª—è –∑–∞—Ö–∏—Å—Ç—É –≤–∫–ª–∞–¥–∫–∏ "–ö–æ–Ω—Ñ—ñ–≥–∏" –≤ Portal
CONFIG_PIN=1234

# ZeroMQ endpoints
ZMQ_COLLECTOR_PUB=tcp://127.0.0.1:5555
ZMQ_MONITOR_PUB=tcp://127.0.0.1:5556
```

### 4. –ó–∞–ø—É—Å—Ç–∏—Ç–∏ —Å–∏–º—É–ª—è—Ç–æ—Ä–∏ (–æ–∫—Ä–µ–º—ñ —Ç–µ—Ä–º—ñ–Ω–∞–ª–∏)
```bash
python simulators/et7017_simulator.py 5020 1
python simulators/et7017_simulator.py 5021 1
python simulators/et7284_simulator.py 5022 1 1000
```

### 5. –ó–∞–ø—É—Å—Ç–∏—Ç–∏ —Å–µ—Ä–≤—ñ—Å–∏ (–æ–∫—Ä–µ–º—ñ —Ç–µ—Ä–º—ñ–Ω–∞–ª–∏)
```bash
# Collector
python collector/main.py

# Monitor
python monitor/main.py

# Portal (–æ–ø–µ—Ä–∞—Ç–æ—Ä—Å—å–∫–∏–π UI)
uvicorn portal.main:app --reload --host 0.0.0.0 --port 8100

# Outbound (REST API –¥–ª—è –∑–æ–≤–Ω—ñ—à–Ω—å–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞)
uvicorn outbound.main:app --reload --host 0.0.0.0 --port 8001
```

### –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞
- –ë–î: `localhost:5433` (psql –∞–±–æ pgAdmin; docker-compose –ø—Ä–æ–±—Ä–∞—Å—É—î 5433‚Üí5432)
- Portal: http://localhost:8100
- Outbound API: http://localhost:8001
- Grafana: http://localhost:3100
- –°–∏–º—É–ª—è—Ç–æ—Ä–∏ (Modbus TCP): –ø–æ—Ä—Ç–∏ 5020, 5021, 5022

**–ü—Ä–∏–º—ñ—Ç–∫–∞:**
- –û–±–ª—ñ–∫–æ–≤—ñ –¥–∞–Ω—ñ —É `.env` ‚Äî —Ç–µ—Å—Ç–æ–≤—ñ, —É –≤—ñ–¥–∫—Ä–∏—Ç–æ–º—É –≤–∏–≥–ª—è–¥—ñ. –ù–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—ñ –∑–∞–º—ñ–Ω–∏—Ç–∏.
- `.env` –º—ñ—Å—Ç–∏—Ç—å: DB credentials, CONFIG_PIN (–¥–ª—è –∑–∞—Ö–∏—Å—Ç—É –≤–∫–ª–∞–¥–∫–∏ "–ö–æ–Ω—Ñ—ñ–≥–∏"), ZeroMQ endpoints
- –î–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è –∑–∞–º—ñ–Ω–∏—Ç–∏ IP –∞–¥—Ä–µ—Å–∏ —Å–∏–º—É–ª—è—Ç–æ—Ä—ñ–≤ —É `config.txt` –Ω–∞ —Ä–µ–∞–ª—å–Ω—ñ IP –º–æ–¥—É–ª—ñ–≤.
- –ê–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è –∑–æ–≤–Ω—ñ—à–Ω—å–æ–≥–æ –¥–æ—Å—Ç—É–ø—É (Outbound API) ‚Äî —á–µ—Ä–µ–∑ VPN (Teltonika RUTX11).

## –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è

–ü–æ–≤–Ω–∏–π —Å–ø–∏—Å–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤: [docs/README.md](docs/README.md)

### –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–Ω—ñ —Ä—ñ—à–µ–Ω–Ω—è (ADR)

| # | –†—ñ—à–µ–Ω–Ω—è | –°—Ç–∞—Ç—É—Å |
|---|---|---|
| [ADR-001](docs/ADR-001-listener-interaction.md) | –í–∑–∞—î–º–æ–¥—ñ—è Collector ‚Üí Monitor ‚Üí Portal —á–µ—Ä–µ–∑ ZeroMQ PUB/SUB —Å–ª—É—Ö–∞—á—ñ–≤: —Ñ–æ—Ä–º–∞—Ç –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å, in-memory —Å—Ç–∞–Ω Portal, –æ–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫ | –ü—Ä–∏–π–Ω—è—Ç–æ |
| [ADR-002](docs/ADR-002-collector-modbus-spec.md) | Collector Modbus Reader: –∫–∞—Ä—Ç–∞ —Ä–µ–≥—ñ—Å—Ç—Ä—ñ–≤ ET-7017/ET-7284, raw value scale, –∫–æ–Ω–≤–µ–Ω—Ü—ñ—è `channel_config`, –ø–æ–≤–µ–¥—ñ–Ω–∫–∞ –ø—Ä–∏ –∑–±–æ—è—Ö, `pg_notify` —Ä–µ–∞–∫—Ü—ñ—è | –ü—Ä–∏–π–Ω—è—Ç–æ |

---

## –ï—Ç–∞–ø–∏ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó

- **–ï—Ç–∞–ø 1:** –Ü–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (PostgreSQL, —Å—Ö–µ–º–∞ –ë–î, Grafana) ‚úÖ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –≥–æ—Ç–æ–≤–∞
- **–ï—Ç–∞–ø 1.5:** –°–∏–º—É–ª—è—Ç–æ—Ä–∏ –º–æ–¥—É–ª—ñ–≤ ICP DAS ‚úÖ –≥–æ—Ç–æ–≤–æ –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è
- **–ï—Ç–∞–ø 2:** Collector ‚Äî Modbus TCP, –Ω–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—è —Å–∏–≥–Ω–∞–ª—ñ–≤, ZeroMQ PUB, –ø–µ—Ä–µ–ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è
- **–ï—Ç–∞–ø 3:** Monitor ‚Äî ZeroMQ SUB, –≤–∏—è–≤–ª–µ–Ω–Ω—è –∞–Ω–æ–º–∞–ª—ñ–π, –∞–ª–µ—Ä—Ç–∏, –ø—Ä–∞–≤–∏–ª–∞ –∑ –ë–î
- **–ï—Ç–∞–ø 4:** –ë–î ‚Äî —ñ–Ω–¥–µ–∫—Å–∏, retention (pg_cron), —Ç—Ä–∏–≥–µ—Ä–∏ –¥–ª—è NOTIFY, —Ç–∞–±–ª–∏—Ü—ñ –∫–æ–Ω—Ñ—ñ–≥—ñ–≤ —Ç–∞ –ª–æ–≥—ñ–≤
- **–ï—Ç–∞–ø 5:** Portal ‚Äî –æ–ø–µ—Ä–∞—Ç–æ—Ä—Å—å–∫–∏–π UI (SSE stream, CRUD –∫–æ–Ω—Ñ—ñ–≥—ñ–≤); Outbound ‚Äî REST API –¥–ª—è –∑–æ–≤–Ω—ñ—à–Ω—å–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
- **–ï—Ç–∞–ø 6:** Grafana ‚Äî –¥–∞—à–±–æ—Ä–¥–∏, –≤–±—É–¥—É–≤–∞–Ω–Ω—è –≤ Portal —á–µ—Ä–µ–∑ iframe

## –°–µ—Ä–≤—ñ—Å–∏ —Å–∏—Å—Ç–µ–º–∏

### Collector
–°–µ—Ä–≤—ñ—Å –∑–±–æ—Ä—É –¥–∞–Ω–∏—Ö –∑ –º–æ–¥—É–ª—ñ–≤ ICP DAS —á–µ—Ä–µ–∑ Modbus TCP (–æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è 1 –ì—Ü).
- –ó—á–∏—Ç—É—î –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é –∫–∞–Ω–∞–ª—ñ–≤ –∑ –ë–î –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ; –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—É—î –±–µ–∑ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫—É —á–µ—Ä–µ–∑ `pg_notify`
- –ù–æ—Ä–º–∞–ª—ñ–∑—É—î —Å–∏–≥–Ω–∞–ª–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ –¥–æ —Ç–∏–ø—É —Ç–∞ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó –∫–∞–Ω–∞–ª—É (–ª—ñ–Ω—ñ–π–Ω–∞ –Ω–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—è)
- –§—ñ–∫—Å—É—î `cycle_time` –Ω–∞ **–ø–æ—á–∞—Ç–∫—É** —Ü–∏–∫–ª—É ‚Äî –≤—Å—ñ –∫–∞–Ω–∞–ª–∏ –æ–¥–Ω–æ–≥–æ —Ü–∏–∫–ª—É –º–∞—é—Ç—å –æ–¥–Ω–∞–∫–æ–≤–∏–π timestamp
- –ó–∞–ø–∏—Å—É—î –≤–∏–º—ñ—Ä—è–Ω—ñ –¥–∞–Ω—ñ –≤ PostgreSQL **–æ–¥–Ω–∏–º –±–∞—Ç—á-—ñ–Ω—Å–µ—Ä—Ç–æ–º** (1 —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è –Ω–∞ —Ü–∏–∫–ª)
- –ü—É–±–ª—ñ–∫—É—î –∫–æ–∂–µ–Ω –ø–∞–∫–µ—Ç –¥–∞–Ω–∏—Ö —á–µ—Ä–µ–∑ **ZeroMQ PUB** –¥–ª—è Monitor —Ç–∞ Portal

### Anomaly Monitor (–Ω–∞–π–≤–∏—â–∏–π –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç) üö®
–ö—Ä–∏—Ç–∏—á–Ω–∏–π —Å–µ—Ä–≤—ñ—Å –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É –¥–∞–Ω–∏—Ö –≤ —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ:
- **–ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞:** –æ—Ç—Ä–∏–º—É—î –¥–∞–Ω—ñ –Ω–∞–ø—Ä—è–º—É –∑ Collector —á–µ—Ä–µ–∑ **ZeroMQ SUB** (–Ω–µ –∑ –ë–î)
- **–ü—Ä–∞–≤–∏–ª–∞ —Ç—Ä–∏–≤–æ–≥:** –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –≤ PostgreSQL, –ø—ñ–¥–≤–∞–Ω—Ç–∞–∂—É—é—Ç—å—Å—è –±–µ–∑ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫—É —Å–µ—Ä–≤—ñ—Å—É
- **–í–∏—è–≤–ª–µ–Ω–Ω—è –∞–Ω–æ–º–∞–ª—ñ–π:** —Å—Ç–∞—Ç–∏—á–Ω—ñ –º–µ–∂—ñ, –≥—Ä–∞–¥—ñ—î–Ω—Ç–∏, —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–Ω—ñ –≤—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è
- **–ê–ª–µ—Ä—Ç–∏:** –ø—É–±–ª—ñ–∫—É—î —á–µ—Ä–µ–∑ **ZeroMQ PUB** ‚Üí Portal ‚Üí SSE ‚Üí –±—Ä–∞—É–∑–µ—Ä –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
- **–ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç:** –∫—Ä–∏—Ç–∏—á–Ω–∏–π –ø—Ä–æ—Ü–µ—Å (–≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ `nice -n -20` –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—ñ)

### Portal ‚Äî –æ–ø–µ—Ä–∞—Ç–æ—Ä—Å—å–∫–∏–π —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å (–ª–æ–∫–∞–ª—å–Ω–∏–π)
–Ñ–¥–∏–Ω–∞ —Ç–æ—á–∫–∞ –≤–∑–∞—î–º–æ–¥—ñ—ó –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –∑ —Å–∏—Å—Ç–µ–º–æ—é –Ω–∞ —É—Å—Ç–∞–Ω–æ–≤—Ü—ñ.

**–ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞:**
- **–Ø–¥—Ä–æ:** FastAPI HTTP —Å–µ—Ä–≤–µ—Ä
  - SSE endpoint `/stream` ‚Äî –ø–æ—Ç—ñ–∫ –¥–∞–Ω–∏—Ö + —Ç—Ä–∏–≤–æ–≥ –≤ –±—Ä–∞—É–∑–µ—Ä (–∑ heartbeat –∫–æ–∂–Ω—ñ 5 —Å–µ–∫)
  - HTTP POST/PUT ‚Äî CRUD –∫–æ–Ω—Ñ—ñ–≥—ñ–≤ –∫–∞–Ω–∞–ª—ñ–≤ —Ç–∞ –ø—Ä–∞–≤–∏–ª —Ç—Ä–∏–≤–æ–≥
  - –¢—Ä–∏–º–∞—î in-memory —Å—Ç–∞–Ω (`current_values`, `active_alarms`)
- **–î–≤–∞ ZeroMQ —Å–ª—É—Ö–∞—á—ñ** (—Ñ–æ–Ω–æ–≤—ñ async –∑–∞–¥–∞—á—ñ):
  - Collector listener ‚Üí –æ–Ω–æ–≤–ª—é—î `current_values`
  - Monitor listener ‚Üí –æ–Ω–æ–≤–ª—é—î `active_alarms`

**–í–µ–±-—ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å (—Ç—Ä–∏ –≤–∫–ª–∞–¥–∫–∏):**
- **–ú–æ–Ω—ñ—Ç–æ—Ä** ‚Äî –ø–æ—Ç–æ—á–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è –≤—Å—ñ—Ö –∫–∞–Ω–∞–ª—ñ–≤ + —Å—Ç—Ä—ñ—á–∫–∞ –∞–∫—Ç–∏–≤–Ω–∏—Ö —Ç—Ä–∏–≤–æ–≥ (SSE stream, —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä Live/Offline)
- **–ì—Ä–∞—Ñ—ñ–∫–∏** ‚Äî Grafana –≤–±—É–¥–æ–≤–∞–Ω–∞ —á–µ—Ä–µ–∑ iframe (kiosk mode, –∑—É–º, —Ç–∞—á—Å–∫—Ä—ñ–Ω)
- **–ö–æ–Ω—Ñ—ñ–≥–∏** ‚Äî —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –Ω–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—ó –∫–∞–Ω–∞–ª—ñ–≤ —Ç–∞ –ø—Ä–∞–≤–∏–ª —Ç—Ä–∏–≤–æ–≥ (–∑–∞—Ö–∏—â–µ–Ω–æ PIN-–∫–æ–¥–æ–º)

**–ë–µ–∑–ø–µ–∫–∞ —Ç–∞ –Ω–∞–¥—ñ–π–Ω—ñ—Å—Ç—å:**
- PIN –∑–∞—Ö–∏—Å—Ç –¥–ª—è CRUD –æ–ø–µ—Ä–∞—Ü—ñ–π (—Ç—ñ–ª—å–∫–∏ —É–ø–æ–≤–Ω–æ–≤–∞–∂–µ–Ω–∏–π –ø–µ—Ä—Å–æ–Ω–∞–ª –º–æ–∂–µ –∑–º—ñ–Ω—é–≤–∞—Ç–∏ –∫–æ–Ω—Ñ—ñ–≥–∏)
- –í–∞–ª—ñ–¥–∞—Ü—ñ—è –∫–æ–Ω—Ñ—ñ–≥—ñ–≤ —á–µ—Ä–µ–∑ Pydantic (–∑–∞–ø–æ–±—ñ–≥–∞–Ω–Ω—è –¥—ñ–ª–µ–Ω–Ω—è –Ω–∞ –Ω—É–ª—å, –Ω–µ–∫–æ—Ä–µ–∫—Ç–Ω—ñ –¥—ñ–∞–ø–∞–∑–æ–Ω–∏)
- SSE heartbeat ‚Äî —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –≤–∏—è–≤–ª—è—î stale data —è–∫—â–æ –Ω–µ–º–∞—î –æ–Ω–æ–≤–ª–µ–Ω—å > 3 —Å–µ–∫
- Grafana –≤ —Ä–µ–∂–∏–º—ñ `kiosk=tv` (–±–µ–∑ –º–µ–Ω—é, —Ç—ñ–ª—å–∫–∏ –≥—Ä–∞—Ñ—ñ–∫–∏)

**–î–æ—Å—Ç—É–ø:** —Ç—ñ–ª—å–∫–∏ –ª–æ–∫–∞–ª—å–Ω–æ (localhost –∞–±–æ –ª–æ–∫–∞–ª—å–Ω–∞ –º–µ—Ä–µ–∂–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏)

### Outbound ‚Äî REST API –¥–ª—è –∑–æ–≤–Ω—ñ—à–Ω—å–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
–ó–∞–±–µ–∑–ø–µ—á—É—î read-only –¥–æ—Å—Ç—É–ø –¥–æ —ñ—Å—Ç–æ—Ä–∏—á–Ω–∏—Ö –¥–∞–Ω–∏—Ö –¥–ª—è —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞.

**–§—É–Ω–∫—Ü—ñ—ó:**
- –ß–∏—Ç–∞–Ω–Ω—è —ñ—Å—Ç–æ—Ä–∏—á–Ω–∏—Ö –¥–∞–Ω–∏—Ö –∑ PostgreSQL –∑–∞ —á–∞—Å–æ–≤–∏–º –¥—ñ–∞–ø–∞–∑–æ–Ω–æ–º
- –°–ø–∏—Å–æ–∫ –∫–∞–Ω–∞–ª—ñ–≤ —Ç–∞ —ó—Ö –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è
- –ú–µ—Ç–∞–¥–∞–Ω—ñ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ç–∞ —Å—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º–∏

**–ü—Ä–∏–∫–ª–∞–¥–∏ endpoints:**
```
GET /data?channel_id=5&from=2024-01-01T00:00:00Z&to=2024-01-02T00:00:00Z
GET /channels
GET /status
```

**–î–æ—Å—Ç—É–ø:** —á–µ—Ä–µ–∑ VPN (Teltonika RUTX11), read-only

### Grafana
–í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è –¥–∞–Ω–∏—Ö —Ç–∞ —Ä–µ–∞–ª—Ç–∞–π–º –¥–∞—à–±–æ—Ä–¥–∏. –í–±—É–¥–æ–≤—É—î—Ç—å—Å—è –≤ Portal —á–µ—Ä–µ–∑ iframe (`allow_embedding = true`).

**–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –¥–ª—è –≤–±—É–¥–æ–≤—É–≤–∞–Ω–Ω—è:**
```ini
# grafana.ini
[security]
allow_embedding = true

[auth.anonymous]
enabled = true
org_role = Viewer
```

**URL –¥–ª—è iframe:** `http://localhost:3100/d/dashboard-uid?orgId=1&kiosk=tv&theme=dark`
- –ü–∞—Ä–∞–º–µ—Ç—Ä `kiosk=tv` –ø—Ä–∏–±–∏—Ä–∞—î –≤—Å—ñ –º–µ–Ω—é Grafana
- –ó–∞–ª–∏—à–∞—î—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ –≥—Ä–∞—Ñ—ñ–∫ ‚Äî —ñ–¥–µ–∞–ª—å–Ω–æ –¥–ª—è —Ç–∞—á—Å–∫—Ä—ñ–Ω—ñ–≤

---

## –ù–∞–¥—ñ–π–Ω—ñ—Å—Ç—å —Ç–∞ –±–µ–∑–ø–µ–∫–∞

### SSE Heartbeat —Ç–∞ –≤–∏—è–≤–ª–µ–Ω–Ω—è stale data
Portal –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î heartbeat –ø–æ–¥—ñ—ó –∫–æ–∂–Ω—ñ 5 —Å–µ–∫—É–Ω–¥ —á–µ—Ä–µ–∑ SSE stream. –§—Ä–æ–Ω—Ç–µ–Ω–¥ –≤—ñ–¥—Å—Ç–µ–∂—É—î —á–∞—Å –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è:
- –Ø–∫—â–æ –Ω–µ–º–∞—î –¥–∞–Ω–∏—Ö > 3 —Å–µ–∫—É–Ω–¥–∏ ‚Üí –ø–æ–∫–∞–∑—É—î —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä "Offline" —Ç–∞ —Å—ñ—Ä—ñ –∑–Ω–∞—á–µ–Ω–Ω—è
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –ø–µ—Ä–µ–ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è SSE –ø—Ä–∏ –æ–±—Ä–∏–≤—ñ –∑'—î–¥–Ω–∞–Ω–Ω—è

### –ó–∞—Ö–∏—Å—Ç –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó
- –í–∫–ª–∞–¥–∫–∞ "–ö–æ–Ω—Ñ—ñ–≥–∏" –∑–∞—Ö–∏—â–µ–Ω–∞ PIN-–∫–æ–¥–æ–º (–∑–º—ñ–Ω–Ω–∞ `CONFIG_PIN` —É `.env`)
- –í–∞–ª—ñ–¥–∞—Ü—ñ—è –Ω–∞ —Ä—ñ–≤–Ω—ñ Pydantic –º–æ–¥–µ–ª–µ–π (–∑–∞–ø–æ–±—ñ–≥–∞–Ω–Ω—è –¥—ñ–ª–µ–Ω–Ω—è –Ω–∞ –Ω—É–ª—å)
- Constraint –Ω–∞ —Ä—ñ–≤–Ω—ñ PostgreSQL (`raw_range_check`)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è –≤—Å—ñ—Ö –∑–º—ñ–Ω —É `channel_config_history`

### –Ü–∑–æ–ª—è—Ü—ñ—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç–∞ –∑–æ–≤–Ω—ñ—à–Ω—å–æ–≥–æ –¥–æ—Å—Ç—É–ø—É
- Portal ‚Äî —Ç—ñ–ª—å–∫–∏ –ª–æ–∫–∞–ª—å–Ω–∏–π –¥–æ—Å—Ç—É–ø (–ø–æ—Ä—Ç 8100)
- Outbound ‚Äî —á–µ—Ä–µ–∑ VPN (–ø–æ—Ä—Ç 8001), read-only
- –ó–∞–ø—É—Å–∫–∞—é—Ç—å—Å—è —è–∫ –æ–∫—Ä–µ–º—ñ –ø—Ä–æ—Ü–µ—Å–∏

### –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è —á–∞—Å—É (NTP)
–î–ª—è –∫–æ—Ä–µ–∫—Ç–Ω–æ—ó –∫–æ—Ä–µ–ª—è—Ü—ñ—ó –ø–æ–¥—ñ–π —Ç–∞ –ª–æ–≥—ñ–≤ –∫—Ä–∏—Ç–∏—á–Ω–æ –≤–∞–∂–ª–∏–≤–æ—é —î —Ç–æ—á–Ω—ñ—Å—Ç—å —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ —á–∞—Å—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ (ASUS NUC).
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è `systemd-timesyncd` –∞–±–æ `chrony` –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó –∑ NTP —Å–µ—Ä–≤–µ—Ä–∞–º–∏.
- –†–æ–∑—Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –º–æ–∂–µ –ø—Ä–∏–∑–≤–µ—Å—Ç–∏ –¥–æ –ø–æ–º–∏–ª–æ–∫ –ø—Ä–∏ –ø–æ–±—É–¥–æ–≤—ñ –≥—Ä–∞—Ñ—ñ–∫—ñ–≤ —Ç–∞ –Ω–µ–∫–æ—Ä–µ–∫—Ç–Ω–æ–≥–æ —Å–ø—Ä–∞—Ü—é–≤–∞–Ω–Ω—è –∞–ª–µ—Ä—ñ–≤ (—Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ `time_diff`).

---

## –ë–∞–∑–∞ –¥–∞–Ω–∏—Ö (PostgreSQL)

| –¢–∞–±–ª–∏—Ü—è | –ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è |
|---|---|
| `measurements` | –¢–∞–±–ª–∏—Ü—è –≤–∏–º—ñ—Ä—é–≤–∞–Ω—å, –ø–∞—Ä—Ç–∏—Ü—ñ–π–æ–≤–∞–Ω–∞ –ø–æ —á–∞—Å—É, retention 90 –¥–Ω—ñ–≤ (pg_cron) |
| `channel_config` | –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è –∫–∞–Ω–∞–ª—ñ–≤: —Ç–∏–ø —Å–∏–≥–Ω–∞–ª—É, –Ω–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—è, –º–µ—Ç–∞–¥–∞–Ω—ñ |
| `channel_config_history` | –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è –∑–º—ñ–Ω –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó –∫–∞–Ω–∞–ª—ñ–≤ (—Ç—Ä–∏–≥–µ—Ä) |
| `alarm_rules` | –ü—Ä–∞–≤–∏–ª–∞ —Ç—Ä–∏–≤–æ–≥ (–º–µ–∂—ñ, –≥—Ä–∞–¥—ñ—î–Ω—Ç–∏ —Ç–æ—â–æ) |
| `alarm_rules_history` | –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è –∑–º—ñ–Ω –ø—Ä–∞–≤–∏–ª —Ç—Ä–∏–≤–æ–≥ (—Ç—Ä–∏–≥–µ—Ä) |
| `alarms_log` | –Ü—Å—Ç–æ—Ä—ñ—è —Å–ø—Ä–∞—Ü—é–≤–∞–Ω—å —Ç—Ä–∏–≤–æ–≥ |

**–ü—Ä–∏–º—ñ—Ç–∫–∞:** `config.txt` –º—ñ—Å—Ç–∏—Ç—å –ª–∏—à–µ —ñ–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ (IP –∞–¥—Ä–µ—Å–∏, –ø–æ—Ä—Ç–∏). –í—Å—è –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è –≤–∏–º—ñ—Ä—é–≤–∞–Ω—å —Ç–∞ –±—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫–∞ ‚Äî –≤ –ë–î.

---

## –°—Ö–µ–º–∞ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö

### `measurements` ‚Äî –¢–∞–±–ª–∏—Ü—è –≤–∏–º—ñ—Ä—é–≤–∞–Ω—å

```sql
CREATE TABLE measurements (
    time        TIMESTAMPTZ NOT NULL,
    channel_id  SMALLINT NOT NULL,
    value       DOUBLE PRECISION
);
) PARTITION BY RANGE (time);

CREATE INDEX ON measurements (channel_id, time DESC);

-- retention —á–µ—Ä–µ–∑ pg_cron (—Ä–∞–∑ –Ω–∞ –¥–æ–±—É)
SELECT cron.schedule('0 3 * * *',
    $$DELETE FROM measurements WHERE time < NOW() - INTERVAL '90 days'$$
);
-- –ü–∞—Ä—Ç–∏—Ü—ñ—é–≤–∞–Ω–Ω—è –¥–æ–∑–≤–æ–ª—è—î –º–∏—Ç—Ç—î–≤–æ –≤–∏–¥–∞–ª—è—Ç–∏ —Å—Ç–∞—Ä—ñ –¥–∞–Ω—ñ (DROP TABLE) –±–µ–∑ "—Ä–æ–∑–ø—É—Ö–∞–Ω–Ω—è" –ë–î (bloat).
-- –†–µ–∫–æ–º–µ–Ω–¥—É—î—Ç—å—Å—è –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è pg_partman –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø–∞—Ä—Ç–∏—Ü—ñ–π.
-- –ü—Ä–∏–∫–ª–∞–¥: CREATE TABLE measurements_p2024_01 PARTITION OF measurements ...
```

**–†—ñ—à–µ–Ω–Ω—è:**
- **Narrow table** (—Ä—è–¥–æ–∫ –Ω–∞ –∫–∞–Ω–∞–ª, –Ω–µ wide) ‚Äî –≥–Ω—É—á–∫—ñ—Å—Ç—å –∑–∞–ø–∏—Ç—ñ–≤, –∑—Ä—É—á–Ω—ñ—Å—Ç—å –¥–ª—è Grafana, –¥–∏–Ω–∞–º—ñ—á–Ω–µ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –∫–∞–Ω–∞–ª—ñ–≤ –±–µ–∑ –º—ñ–≥—Ä–∞—Ü—ñ—ó —Å—Ö–µ–º–∏
- `cycle_time` —Ñ—ñ–∫—Å—É—î—Ç—å—Å—è –Ω–∞ –ø–æ—á–∞—Ç–∫—É —Ü–∏–∫–ª—É –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è ‚Äî –≤—Å—ñ 17 –∫–∞–Ω–∞–ª—ñ–≤ –æ–¥–Ω–æ–≥–æ —Ü–∏–∫–ª—É –º–∞—é—Ç—å **–æ–¥–Ω–∞–∫–æ–≤–∏–π timestamp**, —â–æ –≤–∏—Å—Ç—É–ø–∞—î –ø—Ä–∏—Ä–æ–¥–Ω–∏–º frame ID
- –ó–∞–ø–∏—Å ‚Äî **–±–∞—Ç—á-—ñ–Ω—Å–µ—Ä—Ç** (1 —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è –Ω–∞ —Ü–∏–∫–ª, ~17 —Ä—è–¥–∫—ñ–≤) –¥–ª—è –º—ñ–Ω—ñ–º—ñ–∑–∞—Ü—ñ—ó WAL overhead

---

### `channel_config` ‚Äî –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è –∫–∞–Ω–∞–ª—ñ–≤

```sql
CREATE TYPE signal_type AS ENUM (
    'analog_420',       -- 4‚Äì20 –º–ê, –ª—ñ–Ω—ñ–π–Ω–∞ –Ω–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—è
    'voltage_010',      -- 0‚Äì10 –í, –ª—ñ–Ω—ñ–π–Ω–∞ –Ω–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—è
    'digital',          -- –¥–∏—Å–∫—Ä–µ—Ç–Ω–∏–π –≤—Ö—ñ–¥ 0/1
    'encoder_counter',  -- –ª—ñ—á–∏–ª—å–Ω–∏–∫ —ñ–º–ø—É–ª—å—Å—ñ–≤ 32-bit (–Ω–∞–∫–æ–ø–∏—á—É–≤–∞–ª—å–Ω–∏–π)
    'encoder_frequency' -- —á–∞—Å—Ç–æ—Ç–∞ ‚Üí —à–≤–∏–¥–∫—ñ—Å—Ç—å
);

CREATE TABLE channel_config (
    channel_id      SMALLINT PRIMARY KEY,
    module          VARCHAR(20) NOT NULL,  -- 'et7017_1', 'et7017_2', 'et7284'
    channel_index   SMALLINT NOT NULL,     -- —ñ–Ω–¥–µ–∫—Å –∫–∞–Ω–∞–ª—É –Ω–∞ –º–æ–¥—É–ª—ñ (0-7)
    signal_type     signal_type NOT NULL,
    name            VARCHAR(50) NOT NULL,  -- '–¢–∏—Å–∫ –º–∞—Å–ª–∞', '–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞'
    unit            VARCHAR(20),           -- 'bar', '¬∞C', 'rpm', 'm'
    raw_min         REAL NOT NULL,         -- –Ω–∏–∂–Ω—è –º–µ–∂–∞ —Å–∏—Ä–æ–≥–æ —Å–∏–≥–Ω–∞–ª—É
    raw_max         REAL NOT NULL,         -- –≤–µ—Ä—Ö–Ω—è –º–µ–∂–∞ —Å–∏—Ä–æ–≥–æ —Å–∏–≥–Ω–∞–ª—É
    phys_min        REAL NOT NULL,         -- —Ñ—ñ–∑–∏—á–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è –ø—Ä–∏ raw_min
    phys_max        REAL NOT NULL,         -- —Ñ—ñ–∑–∏—á–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è –ø—Ä–∏ raw_max
    enabled         BOOLEAN DEFAULT TRUE,
    updated_at      TIMESTAMPTZ DEFAULT NOW(),
    
    -- –í–∞–ª—ñ–¥–∞—Ü—ñ—è: –∑–∞–ø–æ–±—ñ–≥–∞–Ω–Ω—è –¥—ñ–ª–µ–Ω–Ω—è –Ω–∞ –Ω—É–ª—å —É —Ñ–æ—Ä–º—É–ª—ñ –Ω–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—ó
    CONSTRAINT raw_range_check CHECK (raw_max != raw_min)
);
```

**–ü—Ä–∏–Ω—Ü–∏–ø –Ω–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—ó ‚Äî —î–¥–∏–Ω–∞ —Ñ–æ—Ä–º—É–ª–∞ –¥–ª—è –≤—Å—ñ—Ö —Ç–∏–ø—ñ–≤:**

```
phys = phys_min + (raw - raw_min) / (raw_max - raw_min) √ó (phys_max - phys_min)
```

`signal_type` –≤–∏–∑–Ω–∞—á–∞—î **—Å–ø–æ—Å—ñ–± —á–∏—Ç–∞–Ω–Ω—è –∑ Modbus** (—Ñ—É–Ω–∫—Ü—ñ—è, —Ä–µ–≥—ñ—Å—Ç—Ä–∏), –∞–ª–µ –Ω–µ –≤–ø–ª–∏–≤–∞—î –Ω–∞ —Ñ–æ—Ä–º—É–ª—É –Ω–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—ó. –ù–æ–≤–∏–π —Ç–∏–ø —Å–∏–≥–Ω–∞–ª—É = –Ω–æ–≤–∏–π ENUM + —Ñ—É–Ω–∫—Ü—ñ—è —á–∏—Ç–∞–Ω–Ω—è; —Å—Ö–µ–º–∞ –ë–î –Ω–µ –∑–º—ñ–Ω—é—î—Ç—å—Å—è.

| signal_type | raw –∑–Ω–∞—á–µ–Ω–Ω—è | —Ç–∏–ø–æ–≤—ñ raw_min / raw_max |
|---|---|---|
| `analog_420` | –º–ê (float) | 4.0 / 20.0 |
| `voltage_010` | –í (float) | 0.0 / 10.0 |
| `digital` | 0 –∞–±–æ 1 | 0 / 1 |
| `encoder_counter` | —ñ–º–ø—É–ª—å—Å–∏ (uint32) | 0 / N (–∑–∞ –∫–æ–Ω—Ñ—ñ–≥–æ–º) |
| `encoder_frequency` | –ì—Ü (float) | 0.0 / N (–∑–∞ –∫–æ–Ω—Ñ—ñ–≥–æ–º) |

---

### `channel_config_history` ‚Äî –ñ—É—Ä–Ω–∞–ª –∑–º—ñ–Ω –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó

```sql
CREATE TABLE channel_config_history (
    id          BIGSERIAL PRIMARY KEY,
    channel_id  SMALLINT NOT NULL,
    changed_at  TIMESTAMPTZ DEFAULT NOW(),
    changed_by  VARCHAR(50),   -- 'operator', 'api', 'system'
    old_config  JSONB NOT NULL,
    new_config  JSONB NOT NULL
);
```

–ó–∞–ø–æ–≤–Ω—é—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Ç—Ä–∏–≥–µ—Ä–æ–º `AFTER UPDATE ON channel_config`. –ó–º—ñ–Ω–∞ –±—É–¥—å-—è–∫–æ–≥–æ –ø–æ–ª—è ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Ñ—ñ–∫—Å—É—î—Ç—å—Å—è –≤ —ñ—Å—Ç–æ—Ä—ñ—ó –±–µ–∑ –¥–æ–¥–∞—Ç–∫–æ–≤–æ–≥–æ –∫–æ–¥—É.

**–ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–æ–Ω—Ñ—ñ–≥—É –≤ Collector** ‚Äî —á–µ—Ä–µ–∑ `pg_notify('config_changed', channel_id)` —É —Ç—Ä–∏–≥–µ—Ä—ñ. Collector –ø—ñ–¥–ø–∏—Å—É—î—Ç—å—Å—è —á–µ—Ä–µ–∑ `LISTEN` —ñ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—É—î –∫–æ–Ω—Ñ—ñ–≥ –º–∏—Ç—Ç—î–≤–æ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫—É —Å–µ—Ä–≤—ñ—Å—É.

**–í–∞–ª—ñ–¥–∞—Ü—ñ—è –Ω–∞ —Ä—ñ–≤–Ω—ñ –∑–∞—Å—Ç–æ—Å—É–Ω–∫—É (Portal):**
```python
# Pydantic model –¥–ª—è –∑–∞—Ö–∏—Å—Ç—É –≤—ñ–¥ –Ω–µ–∫–æ—Ä–µ–∫—Ç–Ω–∏—Ö –¥–∞–Ω–∏—Ö
class ChannelConfigUpdate(BaseModel):
    raw_min: float
    raw_max: float
    phys_min: float
    phys_max: float
    
    @validator('raw_max')
    def validate_range(cls, v, values):
        if 'raw_min' in values and v == values['raw_min']:
            raise ValueError('raw_max must not equal raw_min (division by zero)')
        return v
```

–ë–∞–∑–∞ –¥–∞–Ω–∏—Ö –¥–æ–¥–∞—Ç–∫–æ–≤–æ –∑–∞—Ö–∏—â–µ–Ω–∞ constraint'–æ–º `raw_range_check` —É —Ç–∞–±–ª–∏—Ü—ñ `channel_config`.

---

## –°–∏–º—É–ª—è—Ç–æ—Ä–∏

–î–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è –±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è —Å—Ç–≤–æ—Ä–µ–Ω—ñ —Å–∏–º—É–ª—è—Ç–æ—Ä–∏ –º–æ–¥—É–ª—ñ–≤:
- **ET-7017** √ó 2: —Å–∏–º—É–ª—é—é—Ç—å 8-–∫–∞–Ω–∞–ª—å–Ω—ñ –∞–Ω–∞–ª–æ–≥–æ–≤—ñ –≤—Ö–æ–¥–∏ (4‚Äì20 –º–ê)
- **ET-7284**: —Å–∏–º—É–ª—é—î –ª—ñ—á–∏–ª—å–Ω–∏–∫/–µ–Ω–∫–æ–¥–µ—Ä/—á–∞—Å—Ç–æ—Ç–∞ (32-bit)

–î–µ—Ç–∞–ª—å–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è: –¥–∏–≤. `simulators/README.md`

