{% extends "base.html" %}
{% block title %}{{ vehicle.name }}{% endblock %}

{% block page_header %}
<div class="row mb-2">
  <div class="col-sm-6">
    <ol class="breadcrumb float-sm-left">
      <li class="breadcrumb-item"><a href="/fleet">Автопарк</a></li>
      <li class="breadcrumb-item active">{{ vehicle.name }}</li>
    </ol>
  </div>
  <div class="col-sm-6 text-right">
    {% if vehicle.online %}
    <span class="badge badge-success"><i class="fas fa-circle mr-1"></i>Online</span>
    {% else %}
    <span class="badge badge-secondary">Offline</span>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block content %}
<div class="row">

  <!-- Ліва колонка -->
  <div class="col-lg-4">

    <!-- Інформація -->
    <div class="card card-primary card-outline">
      <div class="card-header"><h5 class="card-title m-0">Інформація</h5></div>
      <div class="card-body p-0">
        <dl class="row p-3 mb-0">
          <dt class="col-sm-5 text-muted">VPN IP</dt>
          <dd class="col-sm-7"><code>{{ vehicle.vpn_ip }}</code></dd>
          <dt class="col-sm-5 text-muted">API порт</dt>
          <dd class="col-sm-7"><code>{{ vehicle.api_port }}</code></dd>
          <dt class="col-sm-5 text-muted">Активність</dt>
          <dd class="col-sm-7">
            {% if vehicle.last_seen_at %}
              {{ vehicle.last_seen_at.strftime('%d.%m %H:%M') }}
            {% else %}<span class="text-muted">—</span>{% endif %}
          </dd>
          <dt class="col-sm-5 text-muted">Sync</dt>
          <dd class="col-sm-7">
            {% if vehicle.sync_status == 'ok' %}<span class="text-success">✓ ok</span>
            {% elif vehicle.sync_status == 'error' %}<span class="text-danger">✗ error</span>
            {% elif vehicle.sync_status == 'timeout' %}<span class="text-warning">⏱ timeout</span>
            {% else %}<span class="text-muted">{{ vehicle.sync_status }}</span>{% endif %}
          </dd>
        </dl>
      </div>
    </div>

    <!-- Тривоги -->
    <div class="card card-warning card-outline">
      <div class="card-header d-flex align-items-center">
        <h5 class="card-title m-0 flex-grow-1">Тривоги</h5>
        <button class="btn btn-sm btn-outline-secondary"
                hx-get="/partials/vehicles/{{ vehicle.id }}/alarms"
                hx-target="#alarms-list" hx-swap="innerHTML">
          <i class="fas fa-sync fa-sm"></i>
        </button>
      </div>
      <div class="card-body p-2">
        <div id="alarms-list">{% include "partials/alarms.html" %}</div>
      </div>
    </div>

    <!-- Live -->
    <div class="card card-success card-outline">
      <div class="card-header"><h5 class="card-title m-0">Live перегляд</h5></div>
      <div class="card-body">
        <button id="live-btn"
                onclick="toggleLive('{{ vehicle.id }}')"
                class="btn btn-success btn-block">
          <span id="live-icon"><i class="fas fa-play mr-1"></i></span>
          <span id="live-text">Запустити Live</span>
        </button>
        <div id="live-status" class="text-center mt-2 small" style="display:none"></div>
      </div>
    </div>

  </div>

  <!-- Права колонка -->
  <div class="col-lg-8">
    <div class="card card-primary card-outline">
      <div class="card-header">
        <h5 class="card-title m-0">Дані в реальному часі</h5>
      </div>
      <div class="card-body">
        <div id="live-offline" class="text-center py-5 text-muted">
          <i class="fas fa-broadcast-tower fa-3x mb-3"></i>
          <p>Натисніть «Запустити Live» для отримання даних</p>
        </div>
        <div id="live-data" style="display:none">
          <div id="live-channels" class="row"></div>
          <small class="text-muted float-right mt-2" id="live-updated"></small>
        </div>
        <div id="live-vehicle-offline" style="display:none" class="text-center py-5">
          <i class="fas fa-wifi fa-3x text-danger mb-3"></i>
          <p class="text-danger">Авто недоступне</p>
          <small class="text-muted">Спроба перепідключення...</small>
        </div>
      </div>
    </div>
  </div>

</div>
{% endblock %}

{% block scripts %}
<script>
let ws = null;
let isLive = false;

function getCookie(name) {
  const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
  return match ? decodeURIComponent(match[2]) : null;
}

function toggleLive(vehicleId) {
  isLive ? stopLive() : startLive(vehicleId);
}

function startLive(vehicleId) {
  const token = getCookie('access_token');
  if (!token) { window.location.href = '/login'; return; }
  const proto = location.protocol === 'https:' ? 'wss' : 'ws';
  ws = new WebSocket(`${proto}://${location.host}/ws/vehicles/${vehicleId}/live?token=${token}`);
  isLive = true;
  updateBtn(true);
  document.getElementById('live-offline').style.display = 'none';
  document.getElementById('live-vehicle-offline').style.display = 'none';
  document.getElementById('live-data').style.display = 'block';

  ws.onmessage = function(event) {
    const msg = JSON.parse(event.data);
    if (msg.status === 'offline') {
      document.getElementById('live-data').style.display = 'none';
      document.getElementById('live-vehicle-offline').style.display = 'block';
      return;
    }
    document.getElementById('live-vehicle-offline').style.display = 'none';
    document.getElementById('live-data').style.display = 'block';
    const container = document.getElementById('live-channels');
    container.innerHTML = '';
    (msg.data || []).forEach(ch => {
      const col = document.createElement('div');
      col.className = 'col-lg-4 col-md-6 col-sm-12 mb-2';
      col.innerHTML = `
        <div class="info-box">
          <span class="info-box-icon bg-info"><i class="fas fa-tachometer-alt"></i></span>
          <div class="info-box-content">
            <span class="info-box-text text-truncate">${ch.channel_id ?? ''}</span>
            <span class="info-box-number">
              ${ch.value !== undefined ? ch.value : '—'}
              <small>${ch.unit ?? ''}</small>
            </span>
          </div>
        </div>`;
      container.appendChild(col);
    });
    const now = new Date();
    document.getElementById('live-updated').textContent = 'Оновлено: ' + now.toLocaleTimeString('uk-UA');
    const s = document.getElementById('live-status');
    s.innerHTML = '<span class="badge badge-success">● Live</span>';
    s.style.display = 'block';
  };

  ws.onerror = ws.onclose = function() {
    if (isLive) {
      const s = document.getElementById('live-status');
      s.innerHTML = '<span class="badge badge-danger">Відключено</span>';
      s.style.display = 'block';
    }
  };
}

function stopLive() {
  if (ws) { ws.close(); ws = null; }
  isLive = false;
  updateBtn(false);
  document.getElementById('live-data').style.display = 'none';
  document.getElementById('live-vehicle-offline').style.display = 'none';
  document.getElementById('live-offline').style.display = 'block';
  document.getElementById('live-status').style.display = 'none';
}

function updateBtn(active) {
  const btn = document.getElementById('live-btn');
  document.getElementById('live-icon').innerHTML = active
    ? '<i class="fas fa-stop mr-1"></i>'
    : '<i class="fas fa-play mr-1"></i>';
  document.getElementById('live-text').textContent = active ? 'Зупинити Live' : 'Запустити Live';
  btn.className = active ? 'btn btn-danger btn-block' : 'btn btn-success btn-block';
}
</script>
{% endblock %}
